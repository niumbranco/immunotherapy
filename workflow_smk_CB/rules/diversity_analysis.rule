# STEP 1: Prepare tables from DADA2 output
rule prepare_tables:
    input:
        seqtab = f"{dada2_dir}/seqtab_nochim.rds",
        taxa = f"{dada2_dir}/taxa.rds"
    output:
        phylum = f"{dada2_dir}/taxonomy_counts_P.tsv",
        genus = f"{dada2_dir}/taxonomy_counts_G.tsv",
        species = f"{dada2_dir}/taxonomy_counts_S.tsv"
    conda:
        f"{ENV_DIR}/r_env.yml"
    script:
        f"{BASEDIR}/scripts/dada2_automated/for_snakemake/prepare_tables_smk.R"

# STEP 2: plot diversity per sample at genus and phylo level
rule plot_taxonomy_composition:
    input:
        phylum = f"{dada2_dir}/taxonomy_counts_P.tsv",
        genus  = f"{dada2_dir}/taxonomy_counts_G.tsv"
    output:
        phylum_pdf = f"{dada2_dir}/visuals/microbial_composition_per_sample_P.pdf",
        genus_pdf  = f"{dada2_dir}/visuals/microbial_composition_per_sample_G.pdf",
        phylum_overview = f"{dada2_dir}/visuals/microbial_composition_overview_P.pdf",
        genus_overview  = f"{dada2_dir}/visuals/microbial_composition_overview_G.pdf"
    conda:
        f"{ENV_DIR}/r_env.yml"
    script:
        f"{BASEDIR}/scripts/dada2_automated/for_snakemake/plot_taxonomy_composition_smk.R"
